# Postgres

We need a database with persistent storage. This will be a single database with multiple tables; I'm anticipating 4? This may change as we progress... 

| Database | Purpose |
| -------- | ------- |
| ftse_data | Stores FTSE100 data |
| treasury_loans | Keeps track of the treasury total<br>money on loan and to whom<br>interest rate<br>risk etc |
| ml_spending | Tracks the three machine learning models and their spending and lending. |
| results | ML results |

I've asked chatGPT for some advice providing my goals as a prompt and it's come up with this:

```
    CREATE TABLE ftse_data (
      id SERIAL PRIMARY KEY,
      symbol VARCHAR(10) NOT NULL,
      price NUMERIC(12, 4) NOT NULL,
      volume BIGINT,
      recorded_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    CREATE TABLE treasury_loans (
      id SERIAL PRIMARY KEY,
      loan_amount NUMERIC(12, 2) NOT NULL,
      borrower VARCHAR(100),
      risk_score NUMERIC(5, 2),
      interest_rate NUMERIC(5, 3),
      issued_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      due_date TIMESTAMPTZ,
      status VARCHAR(20) DEFAULT 'active'
    );
    CREATE TABLE ml_spending (
      id SERIAL PRIMARY KEY,
      model_name VARCHAR(50) NOT NULL,
      amount_spent NUMERIC(12, 2) NOT NULL,
      spent_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    CREATE TABLE model_results (
      id SERIAL PRIMARY KEY,
      model_name VARCHAR(50) NOT NULL,
      result JSONB,
      computed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
```

This is skeletal; but maybe a good starting point for now. It's missing the treasury total.

I also asked for it's advice regarding when these tables are created: at posgres pod runtime or by the pods which write and it's suggested the latter which simplifies the install process somewhat.

## Storage in kubernetes...

## Installing

### Secrets

#### Add a secret

Creating a secret is quite simple, but tricky to remember the exact syntax. I've just set the password as "finance_password" here. 

`kubectl create secret generic postgres-secret --from-literal=password=finance_password`

#### Modifying a secret

Nope - no modification options, you need to delete first and recreate.

Error observed when attempting to overwrite/change a secret:
```
root@labbox:~$ kubectl create secret generic postgres-secret --from-literal=password=a_better_password
error: failed to create secret secrets "postgres-secret" already exists
```

#### Deleting a secret

Easiest one of the lot... typical; the riskiest command is also the easiest.

`kubectl delete secret postgres-secret`


### Problems