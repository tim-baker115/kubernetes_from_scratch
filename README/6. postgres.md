# Postgres

We need a database with persistent storage. This will be a single database with multiple tables; I'm anticipating 4? This may change as we progress... 

| Database | Purpose |
| -------- | ------- |
| ftse_data | Stores FTSE100 data |
| treasury_loans | Keeps track of the treasury total<br>money on loan and to whom<br>interest rate<br>risk etc |
| ml_spending | Tracks the three machine learning models and their spending and lending. |
| results | ML results |

I've asked chatGPT for some advice providing my goals as a prompt and it's come up with this:

```
    CREATE TABLE ftse_data (
      id SERIAL PRIMARY KEY,
      symbol VARCHAR(10) NOT NULL,
      price NUMERIC(12, 4) NOT NULL,
      volume BIGINT,
      recorded_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    CREATE TABLE treasury_loans (
      id SERIAL PRIMARY KEY,
      loan_amount NUMERIC(12, 2) NOT NULL,
      borrower VARCHAR(100),
      risk_score NUMERIC(5, 2),
      interest_rate NUMERIC(5, 3),
      issued_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
      due_date TIMESTAMPTZ,
      status VARCHAR(20) DEFAULT 'active'
    );
    CREATE TABLE ml_spending (
      id SERIAL PRIMARY KEY,
      model_name VARCHAR(50) NOT NULL,
      amount_spent NUMERIC(12, 2) NOT NULL,
      spent_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
    CREATE TABLE model_results (
      id SERIAL PRIMARY KEY,
      model_name VARCHAR(50) NOT NULL,
      result JSONB,
      computed_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
    );
```

This is skeletal; but maybe a good starting point for now. It's missing the treasury total.

I also asked for it's advice regarding when these tables are created: at posgres pod runtime or by the pods which write and it's suggested the latter which simplifies the install process somewhat.

## Storage in kubernetes...

Pod's are predominently designed to be ephemeral in kubernetes. Once they die, their history/volume/data is lost. If they stored a 10mb file on a volume, it's designed to dissapear at the end of the pods lifecycle. This lifecycle is known as a **deployment** in kubernetes. If the pod kept it's storage with it, it would be called a "**Stateful set**" (meaning the pod and it's data "set" are kept together).

Kubernetes offers multiple types of starge for stateful sets:
Local disk - What we'll be using, no resilliancy.
Network storage - E.g NFS. Allows pods to move around nodes and retain their dataset (resilliant).
Cloud storage  - E.g EBS/EFS. Allows pods to move around nodes and retain their dataset (resilliant).

More so this sticks in my head - here's a table

| Deployment type | Storage | End of a lifecycle |
| ----------------| ------- | ------------------ |
| Deployment      | Volume/ephemeral | Data lost |
| Statefulset.    | Persistent | Data kept and retained regardless of the pod's lifecycle |

Storage is a complex beast in kubernetes though, you need the following:

* The space you want to write to.
* The correct permissions for the thing writing to it.
* A yaml file with a defined persistent volume (PV). This includes the full allocated size.
* A definition of the "claim" of the storage (persistentvolumeclaim or PVC). This includes the size you want to use.

Quick example below:
```
apiVersion: v1
kind: PersistentVolume 
metadata:
  name: postgres-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteOnce
  storageClassName: ""
  hostPath:
    path: "/mnt/data/postgres"
  claimRef:
    namespace: default
    name: pgdata-postgres-0
```
This is the complete persistent volume definition.

The relevant/interesting fields are:

| Field | Explanation |
| ----- | ----------- |
| [spec.capacity.storage](../manifests/postgres/storage.yaml#L7) | The size allocated to the pod(s). |
| [spec.accessModes](../manifests/postgres/storage.yaml#L9) | This should be one of the following (this allocated how the pod/pods write to the volume - maybe only one pod can write at a time, maybe loads can, maybe multiple pods can read but not write - etc): ReadWriteOnce, ReadOnlyMany, ReadWriteMany, ReadWriteOncePod. [Definitions of the access modes](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes). |
| [spec.storageClassName](../manifests/postgres/storage.yaml#L10) | This is just a label which can be applied to different types of storage. We may have a slow and fast SAN for example and the names might be "fast" and "slow". I've not set this up, so mines blank. |
| [spec.hostPath.path](../manifests/postgres/storage.yaml#L12) | The path we're writing to within the volume (not the same as what the pod sees!). |
| [spec.claimRef.namespace](../manifests/postgres/storage.yaml#L14) | **IMPORTANT** - This MUST match the namespace of the pod! |
| [spec.claimRef.name](../manifests/postgres/storage.yaml#L15) | **IMPORTANT** - This MUST match the <storage claim>-<name>-0 of the pod! |

I'm sure this could be scripted easily enough... For now, lets just setup what we've got:

```
mkdir -p /mnt/data/postgres #Make a folder on the filesystem in /mnt/data/postgres
chown 999:999 /mnt/data/postgres #999 (emergency services number in the UK! Is the default UID for postgres.)
```
Now make a folder called postgres "somewhere" (**not** in /mnt/data/postgres) and paste the yaml snipped above; call it what you like - but might I suggest [storage.yaml](../manifests/postgres/storage.yaml). I'm putting it in `/tmp/postgres`.

```
### Apply the storage.yaml in the folder:
kubectl apply -f /tmp/postgres

### If you want to delete it (pointing to the folder also works here).
#kubectl delete -f /tmp/postgres/storage.yaml
```
I'm also going to show what a claim looks like (note this is **NOT** complete yaml, but the links in the table will refer to the [statefulset.yaml](../manifests/postgres/statefulset.yaml):

```
<snip>
#A volume mount:
#Multiple paths can exist, but each one needs a unique path and name.
        volumeMounts:
        - name: pgdata
          mountPath: /var/lib/postgresql/data
  
# A volume claim (this sould align with the mount and storage request defined previously).
# Values from this point onwards should roughly align with the storage.
  volumeClaimTemplates:
  - metadata:
      name: pgdata
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: ""      # Match static PV
      resources:
        requests:
          storage: 10Gi
```

... I spent far too long doing the yq for this ...
| Field (incomplete above) | Explanation |
| ----- | ----------- |
| [.spec.template.spec.containers[0].volumeMounts.name](../manifests/postgres/statefulset.yaml#L34) | The name allocated to the volume claim (note that multiple mounts can exist - but each requires a unique name). |
| [.spec.template.spec.containers[0].volumeMounts.name](../manifests/postgres/statefulset.yaml#L35) | The path the pod will see (note that multiple mounts can exist - but each requires a unique path). |
| [.spec.volumeClaimTemplates[].metadata.name](../manifests/postgres/statefulset.yaml#L38) | The name allocated to the volume (note the claimref in storage.yaml). | 
| [.spec.volumeClaimTemplates[].metadata.name](../manifests/postgres/statefulset.yaml#L38) | The name allocated to the volume (note the claimref in storage.yaml). |
| [.spec.volumeClaimTemplates[].spec.accessModes](../manifests/postgres/statefulset.yaml#L40) | The AccessModes allocated to the volume (note the AccessModes in storage.yaml). |
| [.spec.volumeClaimTemplates[].spec.storageClassName](../manifests/postgres/statefulset.yaml#L41) | The storageClassName allocated to the volume (note the storageClassName in storage.yaml). |
| [.spec.volumeClaimTemplates[].spec.resources.requests.storage](../manifests/postgres/statefulset.yaml#L44) | The size of the volume (this must be equal to or less than the storage allocated). |


## Installing

### Secrets

#### Add a secret

Creating a secret is quite simple, but tricky to remember the exact syntax. I've just set the password as "finance_password" here. 

`kubectl create secret generic postgres-secret --from-literal=password=finance_password`

#### Modifying a secret

Nope - no modification options, you need to delete first and recreate.

Error observed when attempting to overwrite/change a secret:
```
root@labbox:~$ kubectl create secret generic postgres-secret --from-literal=password=a_better_password
error: failed to create secret secrets "postgres-secret" already exists
```

#### Deleting a secret

Easiest one of the lot... typical; the riskiest command is also the easiest.

`kubectl delete secret postgres-secret`


### Problems